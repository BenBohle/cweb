#include "cwagger.template.h"
#include <cweb/template.h>

char* cwagger_template(cwagger_endpoint *data, size_t count) {
    cweb_output_init();

    cweb_output_raw("\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"de\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0\">\r\n  <title>API Docs Modern</title>\r\n  ");
    cweb_output_raw("<style>");
    cweb_output_raw("\r\n  /* Layout */\r\n  .layout {\r\n    display: grid;\r\n    grid-template-columns: 340px 1fr;\r\n    gap: 24px;\r\n    max-width: 1200px;\r\n    margin: 32px auto;\r\n    padding: 0 16px;\r\n  }\r\n  .sidebar {\r\n    position: sticky;\r\n    top: 16px;\r\n    align-self: start;\r\n    background: #ffffff;\r\n    border: 1px solid #e2e8ec;\r\n    border-radius: 12px;\r\n    box-shadow: 0 4px 24px rgba(30,61,136,0.06);\r\n    padding: 16px;\r\n  }\r\n  .ins-section h2 {\r\n    margin: 0 0 12px 0;\r\n    font-size: 1.1rem;\r\n    color: #27466f;\r\n  }\r\n  .kv {\r\n    display: grid;\r\n    grid-template-columns: 90px 1fr;\r\n    gap: 8px;\r\n    margin-bottom: 8px;\r\n    font-size: 0.95rem;\r\n  }\r\n  .kv span { color: #556581; }\r\n  .kv code {\r\n    background: #f6f8fb;\r\n    border: 1px solid #e2e8ec;\r\n    border-radius: 6px;\r\n    padding: 6px 8px;\r\n    color: #2d3e50;\r\n    word-break: break-all;\r\n  }\r\n  .sidebar details {\r\n    margin-top: 8px;\r\n    border-top: 1px dashed #e2e8ec;\r\n    padding-top: 8px;\r\n  }\r\n  .sidebar summary {\r\n    cursor: pointer;\r\n    color: #2b5aa7;\r\n    font-weight: 600;\r\n    margin-bottom: 6px;\r\n  }\r\n  .sidebar pre {\r\n    background: #0b1220;\r\n    color: #dfe7ff;\r\n    border-radius: 8px;\r\n    padding: 10px;\r\n    font-family: \"Fira Mono\",\"Roboto Mono\",\"Consolas\",monospace;\r\n    font-size: 0.9rem;\r\n    max-height: 280px;\r\n    overflow: auto;\r\n    margin: 6px 0 0 0;\r\n  }\r\n\r\n  body {\r\n    background: #f7f9fb;\r\n    font-family: 'Segoe UI', Arial, sans-serif;\r\n    color: #2d3e50;\r\n    margin: 0;\r\n    padding: 0;\r\n  }\r\n  main {\r\n    max-width: 800px;\r\n    margin: 0;\r\n    padding: 20px;\r\n    background: #fff;\r\n    box-shadow: 0 4px 32px rgba(30,61,136,0.07);\r\n    border-radius: 18px;\r\n  }\r\n  h1 {\r\n    font-size: 2rem;\r\n    margin-bottom: 32px;\r\n    text-align: center;\r\n  }\r\n  .api-endpoint {\r\n    margin-bottom: 30px;\r\n    border: 1px solid #e2e8ec;\r\n    border-radius: 12px;\r\n    overflow: hidden;\r\n  }\r\n  .endpoint-summary {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 10px;\r\n    padding: 16px 18px;\r\n    background: #f1f5fc;\r\n    cursor: pointer;\r\n    transition: background 0.2s;\r\n  }\r\n  .endpoint-summary:hover { background: #e5eaf6; }\r\n  .method {\r\n    font-weight: bold;\r\n    padding: 2px 10px;\r\n    border-radius: 6px;\r\n    font-size: 1rem;\r\n    text-transform: uppercase;\r\n  }\r\n  .method.get { background: #d2fadd; color: #21996f; }\r\n  .method.post { background: #ffe4be; color: #e29326; }\r\n  .method.put { background: #fdf4dc; color: #a08a00; }\r\n  .method.delete { background: #ffd8da; color: #b80009; }\r\n  .url {\r\n    font-family: \"Fira Mono\", monospace;\r\n    color: #3363a0;\r\n    margin-left: 12px;\r\n  }\r\n  .short-desc { flex: 1; padding-left: 16px; color: #616e88; }\r\n  .expand-icon { font-size: 1.2rem; transition: transform 0.2s; }\r\n  .api-endpoint.open .expand-icon { transform: rotate(180deg); }\r\n  .endpoint-details {\r\n    display: none;\r\n    padding: 18px 24px;\r\n    background: #fbfdff;\r\n    font-size: 1rem;\r\n    border-top: 1px solid #e2e8ec;\r\n  }\r\n  .api-endpoint.open .endpoint-details { display: block; }\r\n  .long-desc { color: #46526d; margin-bottom: 16px; }\r\n  .req-resp-switch { margin-bottom: 16px; }\r\n  .req-resp-switch button {\r\n    background: #f1f5fc;\r\n    border: none;\r\n    padding: 8px 18px;\r\n    border-radius: 5px;\r\n    margin-right: 5px;\r\n    font-size: 0.98rem;\r\n    cursor: pointer;\r\n    color: #3363a0;\r\n    transition: background 0.2s;\r\n    outline: none;\r\n  }\r\n  .req-resp-switch button.active { background: #3363a0; color: #fff; font-weight: bold; }\r\n  .example-area {\r\n    background: #fafbfc;\r\n    border-radius: 8px;\r\n    box-shadow: 0 2px 16px rgba(51,99,160,0.04);\r\n    padding: 12px;\r\n  }\r\n  pre.example {\r\n    font-family: \"Fira Mono\",\"Roboto Mono\",\"Consolas\",monospace;\r\n    font-size: 0.97rem;\r\n    margin: 0;\r\n    color: #394864;\r\n    background: none;\r\n  }\r\n  ");
    cweb_output_raw("</style>");
    cweb_output_raw("\r\n</head>\r\n<body>\r\n  <div class=\"layout\">\r\n    <aside class=\"sidebar\" id=\"inspector\">\r\n      <section class=\"ins-section\">\r\n        <h2>Live Request</h2>\r\n        <div class=\"kv\"><span>Methode</span><code id=\"ins-method\">-</code></div>\r\n        <div class=\"kv\"><span>URL</span><code id=\"ins-url\">-</code></div>\r\n        <div class=\"kv\"><span>Status</span><code id=\"ins-status\">-</code></div>\r\n        <div class=\"kv\"><span>Dauer</span><code id=\"ins-duration\">-</code></div>\r\n        <details open><summary>Request Headers</summary><pre id=\"ins-req-headers\"></pre></details>\r\n        <details open><summary>Request Body</summary><pre id=\"ins-req-body\"></pre></details>\r\n        <details open><summary>Response Headers</summary><pre id=\"ins-resp-headers\"></pre></details>\r\n        <details open><summary>Response Body</summary><pre id=\"ins-resp-body\"></pre></details>\r\n      </section>\r\n    </aside>\r\n\r\n    <main>\r\n      <h1>API Dokumentation</h1>\r\n      ");
  for (size_t i = 0; i < count; i++) {
        cwagger_endpoint *current = &data[i];
      
    cweb_output_raw("\r\n      <section class=\"api-endpoint\">\r\n        <div class=\"endpoint-summary\" onclick=\"toggleEndpoint(this)\">\r\n          <span class=\"method get\">");
    cweb_output_html(current->method);
    cweb_output_raw("</span>\r\n          <span class=\"url\">");
    cweb_output_html(current->path);
    cweb_output_raw("</span>\r\n          <span class=\"short-desc\">");
    cweb_output_html(current->short_description);
    cweb_output_raw("</span>\r\n          <span class=\"expand-icon\">&#9660;</span>\r\n        </div>\r\n        <div class=\"endpoint-details\">\r\n          <p class=\"long-desc\">");
    cweb_output_html(current->short_description);
    cweb_output_raw("</p>\r\n          <!-- onsubmit entfernt, stattdessen data-path und JS-Handler -->\r\n          <form class=\"test-request-form\" data-path=\"");
    cweb_output_html(current->path);
    cweb_output_raw("\">\r\n            <label for=\"method-");
    {
        char temp_str[32];
        snprintf(temp_str, sizeof(temp_str), "%ld", i);
        cweb_output_html(temp_str);
    }
    cweb_output_raw("\">HTTP-Methode:</label>\r\n            <select name=\"method\" id=\"method-");
    {
        char temp_str[32];
        snprintf(temp_str, sizeof(temp_str), "%ld", i);
        cweb_output_html(temp_str);
    }
    cweb_output_raw("\">\r\n              <option value=\"GET\">GET</option>\r\n              <option value=\"POST\">POST</option>\r\n              <option value=\"PUT\">PUT</option>\r\n              <option value=\"DELETE\">DELETE</option>\r\n            </select>\r\n\r\n            <label for=\"body-");
    {
        char temp_str[32];
        snprintf(temp_str, sizeof(temp_str), "%ld", i);
        cweb_output_html(temp_str);
    }
    cweb_output_raw("\">Request Body:</label>\r\n            <textarea name=\"body\" id=\"body-");
    {
        char temp_str[32];
        snprintf(temp_str, sizeof(temp_str), "%ld", i);
        cweb_output_html(temp_str);
    }
    cweb_output_raw("\" rows=\"6\" style=\"width:100%;\">");
    cweb_output_html(current->detail.request_schema);
    cweb_output_raw("</textarea>\r\n            <button type=\"submit\" style=\"margin-top:10px;\">Test Request senden</button>\r\n          </form>\r\n\r\n          <div class=\"req-resp-switch\">\r\n            <button class=\"req-btn active\" onclick=\"switchExample(this,'request')\">Request</button>\r\n            <button class=\"resp-btn\" onclick=\"switchExample(this,'response')\">Response</button>\r\n          </div>\r\n          <div class=\"test-response\" style=\"margin-top:12px; background:#f1f5fc; border-radius:6px; padding:10px; display:none;\"></div>\r\n\r\n          <div class=\"example-area\">\r\n            <pre class=\"example req-example\">\r\n");
    cweb_output_html(current->detail.request_schema);
    cweb_output_raw("\r\n");
    cweb_output_html(current->detail.expected_arguments);
    cweb_output_raw("\r\n            </pre>\r\n            <pre class=\"example resp-example\" style=\"display:none;\">\r\n");
    cweb_output_html(current->detail.response_schema);
    cweb_output_raw("\r\n            </pre>\r\n          </div>\r\n        </div>\r\n      </section>\r\n      ");
 } 
    cweb_output_raw("\r\n    </main>\r\n  </div>\r\n  <script>\r\n");
    cweb_output_raw("  function toggleEndpoint(el) {\r\n    const section = el.closest('.api-endpoint');\r\n    // Alle anderen Endpunkte schließen\r\n    document.querySelectorAll('.api-endpoint.open').forEach(function(other) {\r\n        if (other !== section) {\r\n            other.classList.remove('open');\r\n        }\r\n    });\r\n    // Aktuellen Endpunkt toggeln\r\n    section.classList.toggle('open');\r\n}\r\n\r\n");
    cweb_output_raw("document.addEventListener('DOMContentLoaded', function() {\r\n    document.querySelectorAll('.resp-example').forEach(function(pre) {\r\n        // Whitespace und Zeilenumbrüche entfernen\r\n        const raw = pre.textContent.trim();\r\n        try {\r\n            const obj = JSON.parse(raw);\r\n            pre.textContent = JSON.stringify(obj, null, 2);\r\n        } catch (e) {\r\n            // Kein valides JSON, nichts tun\r\n        }\r\n    });\r\n\r\n    // Submit-Handler für alle Test-Formulare binden (verhindert Redirect/Neuer Tab)\r\n    document.querySelectorAll('.test-request-form').forEach(function(form) {\r\n        form.addEventListener('submit', function(e) {\r\n            e.preventDefault();\r\n            const path = form.dataset.path || '';\r\n            sendTestRequest(form, path);\r\n        });\r\n    });\r\n});\r\n\r\n");
    cweb_output_raw("// Umschalten zwischen Request und Response Beispiel\r\nfunction switchExample(btn, type) {\r\n\tconst parent = btn.closest('.endpoint-details');\r\n\tconst reqBtn = parent.querySelector('.req-btn');\r\n\tconst respBtn = parent.querySelector('.resp-btn');\r\n\tconst reqExample = parent.querySelector('.req-example');\r\n\tconst respExample = parent.querySelector('.resp-example');\r\n  \r\n\tif (type === 'request') {\r\n\t  reqBtn.classList.add('active');\r\n\t  respBtn.classList.remove('active');\r\n\t  reqExample.style.display = 'block';\r\n\t  respExample.style.display = 'none';\r\n\t} else {\r\n\t  reqBtn.classList.remove('active');\r\n\t  respBtn.classList.add('active');\r\n\t  reqExample.style.display = 'none';\r\n\t  respExample.style.display = 'block';\r\n\t}\r\n}\r\n\r\n");
     cweb_output_raw("// Hilfen für Inspector\r\nfunction setText(id, text) {\r\n    const el = document.getElementById(id);\r\n    if (el) el.textContent = text != null ? String(text) : '';\r\n}\r\nfunction setPre(id, text) {\r\n    const el = document.getElementById(id);\r\n    if (!el) return;\r\n    if (!text) { el.textContent = ''; return; }\r\n    try {\r\n        const obj = JSON.parse(text);\r\n        el.textContent = JSON.stringify(obj, null, 2);\r\n    } catch (_) {\r\n        el.textContent = text;\r\n    }\r\n}\r\nfunction headersToString(headers) {\r\n    const lines = [];\r\n    // Response.headers ist iterable\r\n    try {\r\n        headers.forEach((v, k) => lines.push(`${k}: ${v}`));\r\n    } catch (e) {\r\n        // Fallback, falls kein Headers-Objekt\r\n        if (headers && typeof headers === 'object') {\r\n            Object.keys(headers).forEach(k => lines.push(`${k}: ${headers[k]}`));\r\n        }\r\n    }\r\n    return lines.join('\\n');\r\n}\r\n\r\n");
    cweb_output_raw("function sendTestRequest(form, path) {\r\n    const method = (form.method.value || 'GET').toUpperCase();\r\n    const body = form.body.value || '';\r\n    const responseDiv = form.parentNode.querySelector('.test-response');\r\n    responseDiv.style.display = 'block';\r\n    responseDiv.textContent = 'Request wird gesendet...';\r\n\r\n    // Für GET/DELETE keinen Body mitschicken\r\n    const headers = { 'Content-Type': 'application/json' };\r\n    const fetchOptions = { method, headers };\r\n    if (method !== 'GET' && method !== 'DELETE') {\r\n        fetchOptions.body = body;\r\n    }\r\n\r\n    // Inspector: Request anzeigen\r\n    setText('ins-method', method);\r\n    setText('ins-url', path);\r\n    setPre('ins-req-body', body);\r\n    setPre('ins-req-headers', headersToString(headers));\r\n\r\n    const started = performance.now();\r\n\r\n    fetch(path, fetchOptions)\r\n        .then(async resp => {\r\n            const duration = Math.max(0, performance.now() - started).toFixed(0) + ' ms';\r\n            const text = await resp.text();\r\n\r\n            // Inspector: Response anzeigen\r\n            setText('ins-status', `${resp.status} ${resp.statusText || ''}`.trim());\r\n            setText('ins-duration', duration);\r\n            setPre('ins-resp-headers', headersToString(resp.headers));\r\n            setPre('ins-resp-body', text);\r\n\r\n            // Rechte Seite (unter Endpoint) zusammenfassen\r\n            let formatted;\r\n            try {\r\n                formatted = JSON.stringify(JSON.parse(text), null, 2);\r\n            } catch (e) {\r\n                formatted = text;\r\n            }\r\n            responseDiv.textContent = `Status: ${resp.status}\\nDauer: ${duration}\\n\\n${formatted}`;\r\n        })\r\n        .catch(err => {\r\n            setText('ins-status', 'Fehler');\r\n            setText('ins-duration', '-');\r\n            setPre('ins-resp-headers', '');\r\n            setPre('ins-resp-body', String(err));\r\n            responseDiv.textContent = 'Fehler beim Senden des Requests: ' + err;\r\n        });\r\n\r\n    return false; // zusätzliche Absicherung\r\n}\r\n  </script>\r\n</body>\r\n</html>\r\n");

    return cweb_output_get();
}

